<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../bower_components/elmsln-loading/elmsln-loading.html">
<link rel="import" href="../../bower_components/dropdown-select/dropdown-select.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<style>
.vaadin-grid-0 vaadin-grid-table-body.vaadin-grid .vaadin-grid-row.vaadin-grid .vaadin-grid-cell.vaadin-grid:not([detailscell]) > vaadin-grid-cell-content {
  height: unset !important;
}
</style>

<dom-module id="lrnapp-studio-instructor">
  <template>
    <style include="materializecss-styles"></style>
    <style>
      :host {
        display: block;
        align-content: center;
        padding: .8em;
      }
      #loading {
        width: 100%;
        z-index: 1000;
        opacity: .8;
        text-align: center;
        align-content: center;
        justify-content: center;
        height: 100vh;
        position: absolute;
        background-color: white;
      }
      .center-data {
        text-align: center;
      }
      vaadin-grid#material {
        height: 75vh;
        font-family: Roboto, sans-serif;
        --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

        --vaadin-grid-cell: {
          padding: 0;
        };

        --vaadin-grid-header-cell: {
          height: 3.5em;
          color: rgba(0, 0, 0, var(--dark-secondary-opacity));
          font-size: 1em;
        };

        --vaadin-grid-body-cell: {
          height: 3em;
          color: rgba(0, 0, 0, var(--dark-primary-opacity));
          font-size: .8em;
        };

        --vaadin-grid-body-row-hover-cell: {
          background-color: var(--paper-grey-200);
        };

        --vaadin-grid-body-row-selected-cell: {
          background-color: var(--paper-grey-100);
        };

        --vaadin-grid-focused-cell: {
          box-shadow: none;
          font-weight: bold;
        };
      }

      vaadin-grid#material .cell {
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 56px;
      }

      vaadin-grid#material .cell.last {
        padding-right: 24px;
      }

      vaadin-grid#material .cell.numeric {
        text-align: right;
      }

      vaadin-grid#material paper-checkbox {
        --primary-color: var(--paper-indigo-500);
        margin: 0 24px;
      }

      vaadin-grid#material vaadin-grid-sorter {
        --vaadin-grid-sorter-arrow: {
          display: none !important;
        };
      }

      vaadin-grid#material vaadin-grid-sorter .cell {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      vaadin-grid#material vaadin-grid-sorter iron-icon {
        transform: scale(0.8);
      }

      vaadin-grid#material vaadin-grid-sorter:not([direction]) iron-icon {
        color: rgba(0, 0, 0, var(--dark-disabled-opacity));
      }

      vaadin-grid#material vaadin-grid-sorter[direction] {
        color: rgba(0, 0, 0, var(--dark-primary-opacity));
      }

      vaadin-grid#material vaadin-grid-sorter[direction=desc] iron-icon {
        transform: scale(0.8) rotate(180deg);
      }
      vaadin-grid-sorter {
        text-align: center;
      }

      lrndesign-avatar {
        display: inline-block;
      }
      .avatar-label {
        display: inline-block;
        margin-left: .2em;
      }

      .avatar-button {

      }
      .assignment-button {
        height: 1em;
      }
      .project-button {
        height: 1em;
      }
      paper-badge {
        top: 0 !important;
        left: unset !important;
        right: 0;
        z-index: 1;
      }
    </style>
    <iron-ajax auto
      id="projectrequest"
      url="[[sourceProjectPath]]"
      params=""
      handle-as="json"
      last-response="{{_projectData}}"
      on-response="_handleProjectResponse"></iron-ajax>
    <iron-ajax
      id="studentrequest"
      url="[[sourceStudentPath]]"
      params='[[studentParams]]'
      handle-as="json"
      last-response="{{_studentData}}"
      on-response="_handleStudentResponse"></iron-ajax>
    <div id="loading">
      <h3>Loading..</h3>
      <elmsln-loading color="grey-text" size="large"></elmsln-loading>
    </div>
    <dropdown-select id="selectedproject" label="Project">
    <template is="dom-repeat" items="[[projects]]" as="project">
      <paper-item value$="[[project.id]]">[[project.attributes.title]]</paper-item>
    </template>
    </dropdown-select>
    <vaadin-grid hidden$="[[!students]]" column-reordering-allowed id="gradebook" aria-label="Student project list" items="[[students]]">
      <vaadin-grid-column resizable>
        <template class="header">
          <vaadin-grid-sorter path="item.display_name">Student</vaadin-grid-sorter>
        </template>
        <template>
          <paper-button class="avatar-button">
            <lrndesign-avatar label="[[item.display_name]]" src="[[item.avatar]]"></lrndesign-avatar>
            <span class="avatar-label">[[item.display_name]]</span>
          </paper-button>
        </template>
      </vaadin-grid-column>
      <template is="dom-repeat" items="[[assignments]]" as="assignment">
        <vaadin-grid-column resizable>
          <template class="header">
            <vaadin-grid-sorter path="assignment.title">[[assignment.title]]</vaadin-grid-sorter>
          </template>
          <template>
            <template is="dom-if" if="[[_submissionStatus(item, assignment)]]">
              <lrnsys-button icon-class="[[_submissionPiece(item, assignment, 'color')]]" target="_blank" label="[[_submissionPiece(item, assignment, 'title')]]" icon="[[_submissionPiece(item, assignment, 'icon')]]" href="[[_submissionPiece(item, assignment, 'url')]]" id$="student-[[item.id]]-id-[[assignment.id]]"></lrnsys-button>
            </template>
            <template is="dom-if" if="[[!_submissionStatus(item, assignment)]]">
              <paper-button disabled class="project-button" id$="student-[[item.id]]-id-[[assignment.id]]">[[assignment.title]]</paper-button>
            </template>
            <template is="dom-if" if="[[_commentCount(item, assignment)]]">
              <paper-badge for="student-[[item.id]]-id-[[assignment.id]]" label="[[_commentCount(item, assignment)]]"></paper-badge>
            </template>
          </template>
        </vaadin-grid-column>
      </template>
    </vaadin-grid>
  </template>


  <script>
    Polymer({
      is: 'lrnapp-studio-instructor',
      listeners: {
        'selectedproject.change': '_projectChanged',
      },
      properties: {
        /**
         * The projects to render
         */
        projects: {
          type: Array,
          notify: true,
        },
        /**
         * The assignments to render
         */
        assignments: {
          type: Array,
          notify: true,
        },
        /**
         * The submissions to render
         */
        students: {
          type: Array,
          notify: true,
          value: false,
        },
        /**
         * Internal value for mapping the raw response data.
         */
        _projectData: {
          type: Object,
        },
        /**
         * studentParams for the request
         */
        studentParams: {
          type: Object,
          value: {
            'id': null,
          },
        },
        /**
         * Internal value for mapping the raw response data.
         */
        _studentData: {
          type: Object,
        },
        /**
         * Internal width so they are all unified from editing this
         */
        _numWidth: {
          type: String,
          value: '2.25em'
        },
        /**
         * Endpoint for submission data.
         */
        sourcePath: {
          type: String,
          notify: true,
        },
        /**
         * base path for the app
         */
        basePath: {
          type: String,
          notify: true,
        },
      },
      /**
       * Project updated
       */
      _projectChanged: function(e) {
        this.$.loading.hidden = false;
        // this should fire off the new request
        this.studentParams.id = e.detail.value;
        this.$.studentrequest.generateRequest();
      },
      /**
       * Handle response for the whole projects object.
       */
      _handleProjectResponse: function(event) {
        this.$.loading.hidden = true;
        this.set('projects', this._toArray(this._projectData.data.projects));
      },
      /**
       * Handle response for the whole projects object.
       */
      _handleStudentResponse: function(event) {
        this.$.loading.hidden = true;
        this.set('students', []);
        this.set('students', this._toArray(this._studentData.data.students));
        this.set('assignments', []);
        this.set('assignments', this._toArray(this._studentData.data.assignments));
      },
      /**
       * Test student submission status relative to assignments
       */
      _submissionStatus: function(student, assignment) {
        if (student != null && typeof student.assignments[assignment.id] !== typeof undefined && typeof student.assignments[assignment.id].id !== typeof undefined) {
          return true;
        }
        return false;
      },
      /**
       * Return a piece of the submission needed for visualization bc of template scope
       */
      _submissionPiece: function(student, assignment, piece) {
        if (student != null && typeof student.assignments[assignment.id] !== typeof undefined && typeof student.assignments[assignment.id].id !== typeof undefined) {
          var submission = student.assignments[assignment.id];
          switch (piece) {
            case 'url':
              return this.basePath + 'lrnapp-studio-submission/submissions/' + submission.id;
            break;
            case 'title':
              return submission.attributes.title;
            break;
            case 'icon':
              return submission.meta.state_icon;
            break;
            case 'color':
              return submission.meta.state_color;
            break;
          }
        }
        return '';
      },
      /**
       * Return number of comments on an assignment for display.
       */
      _commentCount: function(student, assignment) {
        if (student != null && typeof student.assignmentComments[assignment.id] !== typeof undefined) {
          return student.assignmentComments[assignment.id]
        }
        return false;
      },
      /**
       * Simple way to convert from object to array.
       */
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return obj[key];
        });
      },
    });
  </script>
</dom-module>