<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/materializecss-styles/materializecss-styles.html">
<!--
`lrnapp-book`
A LRN element

@demo demo/index.html

@microcopy
  node / circle - A progress circle on the line
  nodes / items - the list of items in the progress bar
  bubble - reserved for when events fire out of an element or value is tracking events
  percentage - amount complete either in the bar or the nodes themselves
  bar - the underlayed bar that's tracking overall progression
  author mode - authoring mode
-->

<dom-module id="mooc-content">
  <template>
    <style include="materializecss-styles"></style>
    <style>
      :host {
        display: block;
        font-size: 1em;
        box-sizing: content-box;
      }
      :host[loading] #content {
        opacity: .2;
      }
      #content {
        opacity: 1;
        visibility: visible;
        transition: all .4s ease;
      }
    </style>
    <div id="hackycontainer"><style id="hackycsspotterhates"></style></div>
    <div id="anchor"></div>
    <iron-ajax
      id="pageajax"
      params="[[requestParams]]"
      url="[[sourcePath]]"
      handle-as="json"
      on-response="handleResponse"
      last-response="{{pageData}}"
      loading="{{_loading}}"></iron-ajax>
    <app-location route="{{route}}" query-params="{{queryParams}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="[[endPoint]]/:type/:id"
      data="{{data}}"
      tail="{{tail}}"
      query-params="{{queryParams}}">
    </app-route>
    <main id="etb-tool-nav" data-offcanvas="">
      <div class="inner-wrap">
        <section class="main-section etb-book" style="min-height: 318px;">
          <div class="r-header row">
            <div class="r-header__left">
              <div class="book-navigation-header col s12 m12 l12 book-sibling-nav-container book-navigation-header-2">
                <div class="book-navigation-header col s12 m12 l12 book-sibling-nav-container book-navigation-header-<?php print $count ?>">
                  <!-- TOC Icon -->
                  <lrnsys-dialog id="outlinepopover" data-voicecommand="open outline" class="black-text" hover-class="blue darken-4 white-text" label="Outline" header="Outline">
                    <span slot="button">
                      <iron-icon icon="explore"></iron-icon>
                      Outline
                    </span>
                    <div class="elmsln-modal-content" id="block-mooc-helper-mooc-helper-toc-nav-modal">
                      <slot name="outlinemodal"></slot>
                    </div>
                  </lrnsys-dialog>
                  <div id="navigation"><slot name="navigation"></slot></div>
                </div>
              </div>
            </div>
            <div id="options" class="r-header__right">
              <slot name="options"></slot>
            </div>
          </div>
          <div class="elmsln-content-wrap row">
            <div class="s12 push-m2 m10 push-l1 l11 col" role="main">
              <div class="highlighted-block-area">
                <section id="block-mooc-nav-block-mooc-nav-nav" class="mooc-nav-block-left block block-mooc-nav-block contextual-links-region block-mooc-nav-block-mooc-nav" role="navigation" aria-label$="[[outlineTitle]]">
                  <div class="block-mooc-nav-block-mooc-title black white-text">[[outlineTitle]]</div>
                  <div id="outline"><slot name="outline"></slot></div>
                </section>
              </div>
              <div class="push-s1 s9 col">
                <a id="main-content" class="scrollspy" data-scrollspy="scrollspy"></a>
                <div id="content"><slot name="content"></slot></div>
              </div>
            </div>
          </div>
        </section>
        <a class="exit-off-canvas"></a>
      </div>
    </main>
  </template>
  <script>
    Polymer({
      is: 'mooc-content',
      observers: [
        '_routeChanged(data, route, endPoint)',
      ],
      properties: {
        /**
         * Source of data
         */
        sourcePath: {
          type: String,
        },
        /**
         * App route tracking.
         */
        route: {
          type: Object,
          notify: true,
        },
        /**
         * Title for the content
         */
        currentTitle: {
          type: String,
        },
        /**
         * Params for the request for outline/book to load.
         */
        requestParams: {
          type: Object,
          notify: true,
          value: {
            "node": null
          },
        },
        /**
         * Returned data for processing.
         */
        pageData: {
          type: Object,
          value: {},
        },
        /**
         * Ensure scrolling doesn't influence during a transition.
         */
        resetScroll: {
          type: Boolean,
          value: false,
        },
        /**
         * Store current page data.
         */
        responseData: {
          type: Object,
          value: {},
        },
        /**
         * BasePath from drupal
         */
        basePath: {
          type: String,
        },
        /**
         * elmslnCourse from drupal
         */
        elmslnCourse: {
          type: String,
        },
        /**
         * nav title
         */
        outlineTitle: {
          type: String,
        },
        /**
         * Node ID
         */
        nid: {
          type: Number,
        },
        /**
         * loading pegged to the ajax call running
         */
        _loading: {
          type: Boolean,
          observer: '_contentLoading',
          value: false,
        },
        /**
         * loading pegged to the ajax call running
         */
        loading: {
          type: Boolean,
          reflectToAttribute: true,
          value: false,
        },
        /**
         * Aliases
         */
        aliases: {
          type: Array,
        },
      },
      /**
       * Notice loading state has changed.
       */
      _contentLoading: function(newValue, oldValue) {
        if (typeof newValue !== typeof undefined && !newValue) {
          setTimeout(() => {
            this.loading = false;
            this._resetScroll();
          }, 500);
        }
        else {
          this.loading = true;
        }
      },
      /**
       * Callback to push the data into the page.
       */
      handleResponse: function(e) {
        // handle the HTML we just got
        if (typeof this.pageData.data !== typeof undefined) {
          let data = this.pageData.data;
          this.$.content.innerHTML = data.content;
          this.$.navigation.innerHTML = data.topNavigation;
          this.outlineTitle = data.bookOutline.subject;
          // inject styles, destroying previous ones
          this.__injectStyle(data.styles);
          this.$.outline.innerHTML = data.bookOutline.content;
          this.$.options.innerHTML = data.options;
          // fire drupal behaviors.. this is evil. Polymer is invoking Drupal behaviors..
          window.Drupal.attachBehaviors(document, window.Drupal.settings);
        }
      },
      /**
       * If the current route is outside the scope of our app then allow
       * the website to break out of the single page application routing.
       *
       * This is really critical that we get happy paths that don't trigger a redirec
       * loop so some of the logic will seem a bit repetative but we're trying to trap
       * may different potentially valid addresses / use-cases which still must trigger
       * a reload within the app (without looping) and still allow outbound links to go
       * through as they should.
       */
      _routeChanged: function(data, route, endPoint) {
        if (typeof route.path === 'string') {
          if (typeof route.path === 'string') {
            // target for url alias that might be delivered into content
            // and menu items throughout the UI
            let urlAlias = route.path.replace('/' + this.elmslnCourse + '/', '');
            if (route.path.startsWith('/' + this.elmslnCourse + '/node/')) {
              let tmp = route.path.split('/');
              // ensure this is a number so we know what we're doing
              if (!isNaN(parseFloat(tmp[tmp.length-1])) && isFinite(tmp[tmp.length-1])) {
                this.nid = tmp[tmp.length-1];
                // trigger change if data location changed
                this.requestParams.node = this.nid;
                // send request out the door to the actual end point
                this.$.pageajax.generateRequest();
                // @todo better state management in the modal itself
                // so that we can detect if it's open or not without
                // something stupid like this
                // close outline dialog if it's open
                if (this.$.outlinepopover.$.modal.opened) {
                  this.$.outlinepopover.$.modal.opened = false;
                }
               return;
              }
              else if(tmp[tmp.length-1] == 'edit') {
                window.location.reload();
              }
            }
            // test for an node alias, then send off
            else if (typeof this.aliases[urlAlias] !== typeof undefined) {
              this.nid = this.aliases[urlAlias].replace('node/', '');
              // trigger change if data location changed
              this.requestParams.node = this.nid;
              this.$.pageajax.generateRequest();
              // @todo better state management in the modal itself
              // so that we can detect if it's open or not without
              // something stupid like this
              if (this.$.outlinepopover.$.modal.opened) {
                this.$.outlinepopover.$.modal.opened = false;
              }
              return;
            }
            else if (route.path.startsWith(endPoint)) {
              return;
            }
          }
          // reload the page which since route changed will load that page
          window.location.reload();
        }
      },
      /**
       * Reset scroll position visually and internally data wise.
       */
      _resetScroll: function () {
        this.resetScroll = true;
        this.$.anchor.scrollIntoView({block: "start", behavior: "smooth", inline: "nearest"});
      },
      /**
       * Simple way to convert from object to array.
       */
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return obj[key];
        });
      },
      /**
       * Inject styles dynamically from inline CSS blocks.
       * This is a function and capability that will drive Potter nuts.
       * Because of this we're using the unheard of ___ convention. This
       * means that it's such a private function that we wish we'd never
       * actually have thought of it. Fortunately, it came from a stackoverflow
       * article so we don't have to take credit for our own undoing with
       * what this enables.
       */
      __injectStyle : function(style) {
        // target and wipe our id area by force
        if (this.$$('#hackycsspotterhates') != null) {
          Polymer.dom(this.$.hackycontainer).innerHTML = '';
        }
        // construct a new style tag and inject it overtop of what was there previously
        var customStyle = document.createElement('style', 'custom-style');
        customStyle.id = 'hackycsspotterhates';
        // inject our styles
        customStyle.textContent = style;
        // we have now successfully ruined something encapsulated and once beautiful
        Polymer.dom(this.$.hackycontainer).appendChild(customStyle);
      },
    });
  </script>
</dom-module>
