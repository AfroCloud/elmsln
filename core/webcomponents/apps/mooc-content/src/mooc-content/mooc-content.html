<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/materializecss-styles/materializecss-styles.html">
<!--
`lrnapp-book`
A LRN element

@demo demo/index.html

@microcopy
  node / circle - A progress circle on the line
  nodes / items - the list of items in the progress bar
  bubble - reserved for when events fire out of an element or value is tracking events
  percentage - amount complete either in the bar or the nodes themselves
  bar - the underlayed bar that's tracking overall progression
  author mode - authoring mode
-->

<dom-module id="mooc-content">
  <template>
    <style include="materializecss-styles"></style>
    <style>
      :host {
        display: block;
        font-size: 1em;
        box-sizing: content-box;
      }
      :host[loading] #content {
        opacity: .2;
      }
      #content {
        opacity: 1;
        visibility: visible;
        transition: all .4s ease;
      }
    </style>
    <div id="anchor"></div>
    <iron-ajax
      id="pageajax"
      params="[[requestParams]]"
      url="[[sourcePath]]"
      handle-as="json"
      on-response="handleResponse"
      last-response="{{pageData}}"
      loading="{{_loading}}"></iron-ajax>
    <app-location route="{{route}}" query-params="{{queryParams}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="[[endPoint]]/:type/:id"
      data="{{data}}"
      tail="{{tail}}"
      query-params="{{queryParams}}">
    </app-route>
    <main id="etb-tool-nav" data-offcanvas="">
      <div class="inner-wrap">
        <section class="main-section etb-book" style="min-height: 318px;">
          <div class="r-header row">
            <div class="r-header__left">
              <div id="navigation" class="book-navigation-header col s12 m12 l12 book-sibling-nav-container book-navigation-header-2">
                <slot name="navigation"></slot>
              </div>
            </div>
            <div id="options" class="r-header__right">
              <slot name="options"></slot>
            </div>
          </div>
          <div class="elmsln-content-wrap row">
            <div class="s12 push-m2 m10 push-l1 l11 col" role="main">
              <div class="highlighted-block-area">
                <section id="block-mooc-nav-block-mooc-nav-nav" class="mooc-nav-block-left block block-mooc-nav-block contextual-links-region block-mooc-nav-block-mooc-nav" role="navigation" aria-label$="[[outlineTitle]]">
                  <div class="block-mooc-nav-block-mooc-title black white-text">[[outlineTitle]]</div>
                  <div id="outline"><slot name="outline"></slot></div>
                </section>
              </div>
              <div class="push-s1 s9 col">
                <a id="main-content" class="scrollspy" data-scrollspy="scrollspy"></a>
                <div id="content"><slot name="content"></slot></div>
              </div>
            </div>
          </div>
        </section>
        <a class="exit-off-canvas"></a>
      </div>
    </main>
  </template>
  <script>
    Polymer({
      is: 'mooc-content',
      listeners: {
        'route-change': '_routeChange',
      },
      observers: [
        '_routeChanged(data, route, endPoint)',
      ],
      properties: {
        /**
         * Source of data
         */
        sourcePath: {
          type: String,
        },
        /**
         * App route tracking.
         */
        route: {
          type: Object,
          notify: true,
        },
        /**
         * Title for the content
         */
        currentTitle: {
          type: String,
        },
        /**
         * Params for the request for outline/book to load.
         */
        requestParams: {
          type: Object,
          notify: true,
          value: {
            "node": null
          },
        },
        /**
         * Returned data for processing.
         */
        pageData: {
          type: Object,
          value: {},
        },
        /**
         * Ensure scrolling doesn't influence during a transition.
         */
        resetScroll: {
          type: Boolean,
          value: false,
        },
        /**
         * Store current page data.
         */
        responseData: {
          type: Object,
          value: {},
        },
        /**
         * BasePath from drupal
         */
        basePath: {
          type: String,
        },
        /**
         * elmslnCourse from drupal
         */
        elmslnCourse: {
          type: String,
        },
        /**
         * nav title
         */
        outlineTitle: {
          type: String,
        },
        /**
         * Node ID
         */
        nid: {
          type: Number,
        },
        /**
         * loading pegged to the ajax call running
         */
        _loading: {
          type: Boolean,
          observer: '_contentLoading',
          value: false,
        },
        /**
         * loading pegged to the ajax call running
         */
        loading: {
          type: Boolean,
          reflectToAttribute: true,
          value: false,
        },
        /**
         * Lock to ensure things needing to build.
         */
        __notBuilt: {
          type: Boolean,
          value: true,
        },
      },
      /**
       * Notice loading state has changed.
       */
      _contentLoading: function(newValue, oldValue) {
        if (typeof newValue !== typeof undefined && !newValue) {
          setTimeout(() => {
            this.loading = false;
            this._resetScroll();
          }, 500);
        }
        else {
          this.loading = true;
        }
      },
      /**
       * Callback to push the data into the page.
       */
      handleResponse: function(e) {
        // handle the HTML we just got
        if (typeof this.pageData.data !== typeof undefined) {
          let data = this.pageData.data;
          this.$.content.innerHTML = data.content;
          this.$.navigation.innerHTML = data.topNavigation;
          this.outlineTitle = data.bookOutline.subject;
          this.$.outline.innerHTML = data.bookOutline.content;
          this.$.options.innerHTML = data.options;
          // fire drupal behaviors.. this is evil. Polymer is invoking Drupal behaviors..
          window.Drupal.attachBehaviors(document, window.Drupal.settings);
        }
      },
      /**
       * If the current route is outside the scope of our app then allow
       * the website to break out of the single page application routing.
       */
      _routeChanged: function(data, route, endPoint) {
        if (typeof route.path === 'string') {
          if (typeof route.path === 'string') {
            if (route.path.startsWith('/' + this.elmslnCourse + '/node/')) {
              let tmp = route.path.split('/');
              // ensure this is a number.. should be
              if (!isNaN(parseFloat(tmp[tmp.length-1])) && isFinite(tmp[tmp.length-1])) {
                this.nid = tmp[tmp.length-1];
                // trigger change if data location changed
                this.requestParams.node = this.nid;
                // send request out the door to the actual end point
                this.$.pageajax.generateRequest();
               return;
              }
              else if(tmp[tmp.length-1] == 'edit') {
                window.location.reload();
              }
            }
            // allow initial to go through and locking it
            else if (route.path.startsWith(endPoint) && this.__notBuilt) {
              let tmp = route.path.split('/');
              this.__notBuilt = false;
              // ensure this is a number.. should be
              if (!isNaN(parseFloat(tmp.length-1)) && isFinite(tmp.length-1)) {
                this.nid = tmp[tmp.length-1];
                // trigger change if data location changed
                this.requestParams.node = this.nid;
              }
              return;
            }
            else if (route.path.startsWith(endPoint)) {
              return;
            }
          }
          // reload the page which since route changed will load that page
          window.location.reload();
        }
      },
      /**
       * Reset scroll position visually and internally data wise.
       */
      _resetScroll: function () {
        this.resetScroll = true;
        this.$.anchor.scrollIntoView({block: "start", behavior: "smooth", inline: "nearest"});
      },
      /**
       * Simple way to convert from object to array.
       */
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return obj[key];
        });
      },
    });
  </script>
</dom-module>
