<?php
/**
 * @file
 * Supply tokens related to ELMSLN like CIS, section context, etc.
 */

/**
 * Provide replacement values for placeholder tokens.
 *
 * @see http://api.drupal.org/api/drupal/modules--system--system.api.php/function/hook_tokens/7
 * @see http://www.benmarshall.me/drupal-custom-tokens
 * @param string $type
 *   The machine-readable name of the type (group) of token being replaced, such
 *   as 'node', 'user', or another type defined by a hook_token_info()
 *   implementation.
 * @param array $tokens
 *   An array of tokens to be replaced. The keys are the machine-readable token
 *   names, and the values are the raw [type:token] strings that appeared in the
 *   original text.
 * @param array $data (optional)
 *   An associative array of data objects to be used when generating replacement
 *   values, as supplied in the $data parameter to token_replace().
 * @param array $options (optional)
 *   An associative array of options for token replacement; see token_replace()
 *   for possible values.
 * @return array
 *   An associative array of replacement values, keyed by the raw [type:token]
 *   strings from the original text.
 */
function cis_tokens_tokens($type, $tokens, $data = array(), $options = array()) {
  $replacements = array();
  $sanitize = !empty($options['sanitize']);
  // tokens from section
  if ($type == 'elmsln_section') {
    $section_tokens = _cis_tokens_get_token_scope();
    foreach ($tokens as $name => $original) {
      // elements we know about ahead of time
      switch ($name) {
        case 'section_context':
          $replacements[$original] = _cis_connector_section_context();
        break;
        default:
          // see if one of our global tokens is matched
          if (isset($section_tokens[$name])) {
            $replacements[$original] = '<span class="cis_token_dynamic_value">' . $section_tokens[$name] . '</span>';
          }
        break;
      }
    }
  }
  // tokens from cis
  if ($type == 'elmsln_cis') {
    foreach ($tokens as $name => $original) {
      // elements we know about ahead of time
      switch ($name) {
        case 'welcome_page':
        case 'contact_info':
        case 'other_services':
        case 'help':
        case 'resources':
          $data = _cis_connector_transaction($name);
          $replacements[$original] = '<span class="cis_token_dynamic_value">' . $data['value'] . '</span>';
        break;
        case 'welcome_letter':
        case 'syllabus':
          $data = _cis_connector_transaction($name);
          $replacements[$original] = '<span class="cis_token_dynamic_value">' . $data . '</span>';
        break;
      }
    }
  }
  return $replacements;
}

/**
 * Provide information about our custom tokens.
 *
 * @see http://api.drupal.org/api/drupal/modules--system--system.api.php/function/hook_token_info/7
 * @see http://www.benmarshall.me/drupal-custom-tokens
 * @return array
 *   An associative array of available tokens and token types.
 */
function cis_tokens_token_info() {
  // define the types that we can process
  $types = array(
    'elmsln_cis' => array(
      'name' => t('ELMSLN: CIS'),
      'description' => t('Pull data from CIS / a remote but related scope.'),
    ),
    'elmsln_section' => array(
      'name' => t('ELMSLN: Section'),
      'description' => t('Data related to the section context, which is related but not the same as og context.'),
    )
  );
  // tokens per type
  $tokens = array(
    'elmsln_cis' => array(
      'contact_info' => array(
        'name' => t("Contact Info"),
        'description' => t("Instructor contact info for the section in question, pulled from CIS."),
      ),
      'welcome_page' => array(
        'name' => t("Welcome Page"),
        'description' => t("Welcome page for the section in question, pulled from CIS."),
      ),
      'other_services' => array(
        'name' => t("Other Services"),
        'description' => t("Other services for the section in question, pulled from CIS."),
      ),
      'help' => array(
        'name' => t("Help"),
        'description' => t("Help page for the section in question, pulled from CIS."),
      ),
      'resources' => array(
        'name' => t("Resources"),
        'description' => t("Resources for the section in question, pulled from CIS."),
      ),
      // smaller items
      'syllabus' => array(
        'name' => t("Syllabus"),
        'description' => t("Syllabus for the section in question, pulled from CIS."),
      ),
      'welcome_letter' => array(
        'name' => t("Welcome letter"),
        'description' => t("Welcome letter for the section in question, pulled from CIS."),
      ),
    ),
    'elmsln_section' => array(
      'section_context' => array(
        'name' => t("Section Context"),
        'description' => t("Section ID of the section currently in context"),
      ),
    ),
  );
  // dynamically generate the global tokens based on those defined globally
  // as well as per the section. Section always takes priority in this value
  $global = _cis_tokens_get_token_scope();
  foreach ($global as $key => $val) {
    $tokens['elmsln_section'][$key] = array(
      'name' => str_replace('_', ' ', $key),
      'description' => t('Global token whose value is currently @val', array('@val' => $val)),
    );
  }

  return array(
    'types' => $types,
    'tokens' => $tokens,
  );
}

/**
 * Implements hook_node_prepare().
 */
function cis_tokens_node_prepare($node) {
  if ($node->type == 'section' && !isset($node->field_cis_tokens[LANGUAGE_NONE])) {
    $node->field_cis_tokens['und'][0]['value'] = variable_get('cis_tokens_global', _cis_tokens_sane_defaults());
  }
}

/**
 * Return the correct tokens as a merger of global and other alters
 * @return  array an array of sanitized key => value pairs
 */
function _cis_tokens_get_token_scope() {
  // @todo allow sections to override the default list
  $tokens = array();
  $tmp = variable_get('cis_tokens_global', _cis_tokens_sane_defaults());
  $section = _cis_section_load_section_by_id(_cis_connector_section_context());
  if (is_numeric($section)) {
    $section = node_load($section);
    // allow for active section overrides
    if (isset($section->field_cis_tokens[LANGUAGE_NONE]) && !empty($section->field_cis_tokens[LANGUAGE_NONE][0]['safe_value'])) {
      $tmp = $section->field_cis_tokens[LANGUAGE_NONE][0]['safe_value'];
    }
  }
  $tmp = explode("\n", $tmp);
  foreach ($tmp as $tmppair) {
    $pair = explode("|", $tmppair, 2);
    if (count($pair) === 2) {
      $tokens[check_plain(filter_xss($pair[0]))] = check_plain(filter_xss($pair[1]));
    }
    else {
      drupal_set_message(t("Section token course not be understood: @line", array('@line' => $tmppair)),'warning');
    }
  }
  return $tokens;
}

/**
 * Implementation of hook_form_cis-service-connection-ux-form_alter().
 */
function cis_tokens_form_cis_service_connection_ux_form_alter(&$form, &$form_state, $form_id) {
  /* Your code here */
  $form['site_information']['cis_tokens_global'] = array(
    '#title' => t('Tokens'),
    '#type' => 'textarea',
    '#description' => t('This is a list of token replacement|value pairs that can be used throughout the course. This is useful when wanting to centralize where you update noodle-y information throughout course content which might otherwise be standalone. For example, writing start_date|June 15, 2015 would allow you to write [elmsln_section:start_date] in your content and have it automatically replaced with June 15, 2015.'),
    '#default_value' => variable_get('cis_tokens_global', _cis_tokens_sane_defaults()),
    '#weight' => 10,
  );
}

/**
 * Return a decent list of defaults to work with in a course
 * @return string key|value pairs separated by endlines \n
 */
function _cis_tokens_sane_defaults() {
  $defaults = '';
  // example module names
  $defaults .= 'module_1|Module 1' . "\n";
  $defaults .= 'module_2|Module 2' . "\n";
  $defaults .= 'module_3|Module 3' . "\n";
  $defaults .= 'module_4|Module 4' . "\n";
  $defaults .= 'module_5|Module 5' . "\n";
  // example dates
  $defaults .= 'module_date_1|8/24 - 8/30' . "\n";
  $defaults .= 'module_date_2|8/31 - 9/14' . "\n";
  $defaults .= 'module_date_3|9/15 - 9/28' . "\n";
  $defaults .= 'module_date_4|9/29 - 10/12' . "\n";
  $defaults .= 'module_date_5|10/13 - 10/26';
  return $defaults;
}
