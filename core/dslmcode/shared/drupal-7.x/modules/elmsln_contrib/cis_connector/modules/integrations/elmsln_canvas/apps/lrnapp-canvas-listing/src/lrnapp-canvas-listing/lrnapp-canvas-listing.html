<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<dom-module id="lrnapp-canvas-listing">
  <template>
    <style include="materializecss-styles"></style>
    <style>
      :host {
        display: block;
      }
      vaadin-grid#material {

        font-family: Roboto, sans-serif;
        --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

        --vaadin-grid-cell: {
          padding: 0;
        };

        --vaadin-grid-header-cell: {
          height: 64px;
          color: rgba(0, 0, 0, var(--dark-secondary-opacity));
          font-size: 12px;
        };

        --vaadin-grid-body-cell: {
          height: 48px;
          color: rgba(0, 0, 0, var(--dark-primary-opacity));
          font-size: 13px;
        };

        --vaadin-grid-body-row-hover-cell: {
          background-color: var(--paper-grey-200);
        };

        --vaadin-grid-body-row-selected-cell: {
          background-color: var(--paper-grey-100);
        };

        --vaadin-grid-focused-cell: {
          box-shadow: none;
          font-weight: bold;
        };
      }

      vaadin-grid#material .cell {
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 56px;
      }

      vaadin-grid#material .cell.last {
        padding-right: 24px;
      }

      vaadin-grid#material .cell.numeric {
        text-align: right;
      }

      vaadin-grid#material paper-checkbox {
        --primary-color: var(--paper-indigo-500);
        margin: 0 24px;
      }

      vaadin-grid#material vaadin-grid-sorter {
        --vaadin-grid-sorter-arrow: {
          display: none !important;
        };
      }

      vaadin-grid#material vaadin-grid-sorter .cell {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      vaadin-grid#material vaadin-grid-sorter iron-icon {
        transform: scale(0.8);
      }

      vaadin-grid#material vaadin-grid-sorter:not([direction]) iron-icon {
        color: rgba(0, 0, 0, var(--dark-disabled-opacity));
      }

      vaadin-grid#material vaadin-grid-sorter[direction] {
        color: rgba(0, 0, 0, var(--dark-primary-opacity));
      }

      vaadin-grid#material vaadin-grid-sorter[direction=desc] iron-icon {
        transform: scale(0.8) rotate(180deg);
      }

      paper-card {
        width: 20rem;
      }
      lrndesign-avatar {
        display:inline-flex;
      }
      lrnsys-dialog {
        display: inline-flex;
      }
      lrnsys-dialog #dialog-trigger span {
        pointer-events: none;
      }
      .avatar-name {
        line-height: 2em;
        margin: 0;
        display:inline-block;
      }
      .loading-hide {
        display: none;
      }
    </style>
    <iron-ajax auto
      url="[[sourcePath]]"
      params='{"return": "courses"}'
      handle-as="json"
      on-response="handleResponse"
      last-response="{{queryResponse}}"></iron-ajax>
    <div id="loading">
      <p>Loading..</p>
      <elmsln-loading color="grey-text" size="epic"></elmsln-loading>
    </div>
    <!-- The array is set as the <vaadin-grid>'s "items" property -->
    <vaadin-grid id="material" aria-label="Course list" items="[[_toArray(courses)]]">
      <vaadin-grid-column width="50px" flex-grow="0">
        <template class="header">#</template>
        <template>[[index]]</template>
        <template class="footer">#</template>
      </vaadin-grid-column>

      <vaadin-grid-column>
        <template class="header">
          <span draggable="true">
            Name
          </span>
        </template>
        <template>
          <span draggable="true">
            [[item.name]]
          </span>
        </template>
        <template class="footer">Name</template>
      </vaadin-grid-column>
      <vaadin-grid-column>
        <template class="header">
          <span draggable="true">
            Sections
          </span>
        </template>
        <template>
          <span draggable="true">
            [[item.sections]]
          </span>
        </template>
        <template class="footer">Sections</template>
      </vaadin-grid-column>
      <vaadin-grid-column>
        <template class="header">Student #</template>
        <template>[[item.student_count]]</template>
        <template class="footer">Student #</template>
      </vaadin-grid-column>
      <vaadin-grid-column>
        <template class="header">Details</template>
        <template>
          <lrnsys-dialog raised on-click="_triggerDialog" id$="{{item.sis_course_id}}" text="Details" alt$="{{item.name}} details" header="{{item.name}}">
            <div id="loadingRoster"></div>
            <div id="loadingContent">
              <div><iron-image src$="{{activeCourse.image}}"></iron-image></div>
              <div>{{activeCourse.sections}} sections</div>
              <div>{{activeCourse.student_count}} students</div>
              <div>SIS ID: {{activeCourse.sis_course_id}}</div>
              <div>Workflow: {{activeCourse.workflow_state}}</div>
              <template is="dom-repeat" items="[[_toArray(roster)]]" as="roleList">
                <h3>{{roleList.role}}</h3>
                <template is="dom-repeat" items="[[_toArray(roleList.users)]]" as="user">
                  <div class="avatar-name" id$="user{{user.id}}">
                    <lrndesign-avatar label$="{{user.name}}" jdenticon src$="{{user.picture}}"></lrndesign-avatar>
                    <span>{{user.name}}</span>
                  </div>
                  <paper-tooltip for$="user{{user.id}}">{{user.email}}</paper-tooltip>
                </template>
              </template>
            </div>
          </lrnsys-dialog>
        </template>
        <template class="footer">Details</template>
      </vaadin-grid-column>
    </vaadin-grid>
      <iron-ajax
      id="request"
      url="[[sourcePath]]"
      params='{"return": "users"}'
      handle-as="json"
      on-response="handleRosterResponse"
      last-response="{{queryResponse}}"></iron-ajax>
  </template>

  <script>
    Polymer({

      is: 'lrnapp-canvas-listing',

      properties: {
        courses: {
          type: Array,
          notify: true,
        },
        roster: {
          type: Array,
          notify: true,
        },
        queryResponse: {
          type: Array,
          notify: true,
        },
        sourcePath: {
          type: String,
          notify: true,
        },
        activeCourse: {
          type: String,
          notify: true,
          reflectToAttribute: true,
        },
        rosterContent: {
          type: Array,
          notify: true,
        }
      },
      /**
       * Simple way to convert from object to array.
       */
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return obj[key];
        });
      },
      _triggerDialog: function(e) {
        let root = this;
        var target = e.target
        // account for hitting the span
        if (target.tagName == 'SPAN') {
          target = target.parentElement.parentElement;
        }
        else if (target.tagName == 'PAPER-BUTTON') {
          target = target.parentElement;
        }
        else {
          console.log(target);
        }
        root.activeCourse = root.courses[target.id];
        root.$$('#request').params['sis_course_id'] = root.activeCourse.sis_course_id;
        root.$$('#request').generateRequest();
        root.$$('#loadingRoster').innerHTML = '<p>Loading..</p><elmsln-loading color="grey-text" size="epic"></elmsln-loading>';
        root.$$('#loadingContent').classList.add('loading-hide');
      },
      handleResponse: function() {
        let root = this;
        root.courses = root.queryResponse.data;
        console.log(root.courses);
        root.$$('#loading').innerHTML = '';
      },
      handleRosterResponse: function() {
        let root = this;
        root.roster = root.queryResponse.data;
        //root.rosterContent = new Array();
        for (var i=0; i<root.roster.length; i++) {
          root.rosterContent[i] = {
            'icon': 'user',
            'label': root.roster[i].role,
            'content': 'Content here'
          };
        }
        root.$$('#loadingContent').classList.remove('loading-hide');
        root.$$('#loadingRoster').innerHTML = '';
      }
    });
  </script>
</dom-module>
