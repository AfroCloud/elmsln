<?php
/**
 * @file
 * Code for the ELMSLN Core feature.
 */

include_once 'elmsln_core.features.inc';

/**
 * Implements hook_permission().
 */
function elmsln_core_permission() {
  return array(
    'access elmsln administration areas' =>  array(
      'title' => t('Administer ELMSLN configuration'),
      'description' => t('Grants access to administrative areas of ELMSLN like network configuration and settings pages.'),
    ),
  );
}

/**
 * Implements hook_node_prepare().
 */
function elmsln_core_node_prepare($node) {
  if (!isset($node->nid)) {
    drupal_add_js(drupal_get_path('module', 'elmsln_core') . '/field-focus.js');
  }
}

/**
 * Implements hook_preprocess().
 *
 * Add a class to match our view-modes
 */
function elmsln_core_preprocess(&$variables, $hook) {
  if ($hook == 'node') {
    $variables['classes_array'][] = $hook . '-view-mode-' . $variables['view_mode'];
  }
}

/**
 * Implements hook_page_build().
 */
function elmsln_core_page_build(&$page) {
  // enable jquery cookie for all pages since we store a bunch of stuff local to the user account
  drupal_add_library('system', 'jquery.cookie');
  // get the configuration so we can set domain from here to enable
  // secure and policy compliant access to sub-domain cookies on
  // the client side. This clears up MULTIPLE issues at once and is
  // awesome!
  $cfg = _cis_connector_get_cfg();
  // pass variables to js
  $js_variables = array(
    'elmslnCore' => array(
      'domain' => '.' . $cfg['address'],
    ),
  );
  drupal_add_js($js_variables, 'setting');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function elmsln_core_form_a11y_admin_settings_alter(&$form, &$form_state) {
  // inject the correct value here
  $cfg = _cis_connector_get_cfg();
  $form['a11y_domain']['#default_value'] = '.' . $cfg['address'];
}