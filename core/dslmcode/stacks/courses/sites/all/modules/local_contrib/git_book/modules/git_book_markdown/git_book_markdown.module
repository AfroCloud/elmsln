<?php
/**
 * @file
 * Slight modifications to our markdown editor integration.
 */


/**
 * Implements hook_wysiwyg_editor_settings_alter().
 * Support for WYSIWYG editor epiceditor
 */
function git_book_markdown_wysiwyg_editor_settings_alter(&$settings, $context) {
  if ($context['editor']['name'] == 'epiceditor') {
    $settings['theme'] = 'epic-light';
    $settings['preview_theme'] = 'github';
    $settings['useNativeFullscreen'] = FALSE;
  }
}

/**
 * Implements hook_git_book_make_node_alter().
 */
function git_book_markdown_git_book_make_node_alter(&$node) {
  $node->body[LANGUAGE_NONE][0]['format'] = 'git_book_markdown';
}

/**
 * Implements hook_node_prepare().
 */
function git_book_markdown_node_prepare($node) {
  if (isset($node->book) && (arg(1) == 'add' || empty($node->body))) {
    $book = node_load($node->book['bid']);
    if ($book && $book->type == 'git_book') {
      // hijack default input format to be markdown
      $node->body[LANGUAGE_NONE][0]['format'] = 'git_book_markdown';
    }
  }
}

/**
 * Implements hook_filter_info_alter().
 */
function git_book_markdown_filter_info_alter(&$info) {
  $info['filter_markdown']['process callback'] = '_git_book_filter_markdown';
}

/**
 * Filter process callback, fork of markdown module filter after altering this in.
 * @see   _filter_markdown()
 */
function _git_book_filter_markdown($text, $format) {
  if (!empty($text)) {
    // fix h1-h5 to shift down the document order
    $text = preg_replace('{
      ^(\#{1,5})  # $1 = string of #\'s
      [ ]*
      (.+?)   # $2 = Header text
      [ ]*
      \#*     # optional closing #\'s (not counted)
      \n+
    }xm', '#${0}', $text);
    return _filter_markdown($text, $format);
  }

  return $text;
}