<?php
/**
 * @file
 * Drupal needs this blank file.
 */

/**
 * Implements hook_menu().
 */
  function elmsln_cdn_menu() {
    // Admin UI.
    $items['admin/config/development/elmsln_cdn'] = array(
      'title'            => 'ELMSLN CDN',
      'description'      => 'Configure ELMSLN CDN integration.',
      'access arguments' => array(CDN_PERM_ADMIN),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array('elmsln_cdn_admin_general_settings_form'),
      'type'             => MENU_NORMAL_ITEM,
      'file'             => 'elmsln_cdn.admin.inc',
    );

    return $items;
  }

/**
 * Implements hook_module_implements_alter().
 */
function elmsln_cdn_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'js_alter') {
    $group = $implementations['elmsln_cdn'];
    unset($implementations['elmsln_cdn']);
    $implementations['elmsln_cdn'] = $group;
  }
}

/**
 * Implements hook_js_alter().
 */
function elmsln_cdn_js_alter(&$javascript) {
  foreach ($javascript as $path => $values) {
    if (strpos(strval($path), 'sites/all/libraries/') !== FALSE) { 
      $path_end = explode('sites/all/libraries/', $path)[1];
      $arr = explode("/", $path_end, 2);
      $name = $arr[0];
      $library = libraries_detect("$name");
      $version = $library['version'];
      if (!empty($library) && !empty($version)) {
        if (variable_get('CDN_CHOICE') === 'CDN_JSDELIVR'){
          \Drupal\libraries_cdn\LibrariesCDN::setPlugin('jsdelivr', $name);
        }
        elseif (variable_get('CDN_CHOICE') === 'CDN_CDNJS') {
          \Drupal\libraries_cdn\LibrariesCDN::setPlugin('cdnjs', $name);
        }
        else{
          //use local logic...
        }
        $cdn_version_arr = \Drupal\libraries_cdn\LibrariesCDN::getFiles();
        if(array_key_exists($version, $cdn_version_arr)) {
          $files = $cdn_version_arr[$version];
          dpm("Found a File Version Match");
          foreach ($files as $index => $value) {
            $javascript[$path]['data'] = strval($files[$index]);
            $javascript[$name]['type'] = 'external';
          }
        }
      }
    }
  }
}
