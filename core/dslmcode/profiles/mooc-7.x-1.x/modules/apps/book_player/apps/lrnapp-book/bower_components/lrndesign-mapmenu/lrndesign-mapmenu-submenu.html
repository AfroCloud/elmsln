<link rel="import" href="lrndesign-mapmenu-item.html">
<link rel="import" href="lrndesign-mapmenu-header.html">


<dom-module id="lrndesign-mapmenu-submenu">
  <template>
    <style>
      :host {
        display: block;
      }
      :host([collapsable]) > lrndesign-mapmenu-header {
        cursor: pointer;
        display: block;
      }
      #container {
        padding: .5em;
        line-height: 2em;
        min-height: 2em;
        text-overflow: ellipsis;
        width: 95%;
        font-size: .9em;
        word-wrap: break-word;
        word-break: break-word;
        clear: both;
      }
      #container ::slotted(lrndesign-mapmenu-item) {
        margin-top: .4em;
      }
    </style>
    <lrndesign-mapmenu-header id="header" avatar-label="[[avatarLabel]]" title="[[title]]" label="[[label]]" opened="[[opened]]" url="[[url]]"></lrndesign-mapmenu-header>
    <iron-collapse id="container">
      <slot id="slot"></slot>
    </iron-collapse>
  </template>
  <script>
    Polymer({
      is: 'lrndesign-mapmenu-submenu',
      listeners: {
        'header.click' : '_headerTapHandler',
      },
      properties: {
        title: {
          type: String
        },
        avatarLabel: {
          type: String
        },
        label: {
          type: String
        },
        opened: {
          type: Boolean,
          value: false,
          observer: '_openChanged',
        },
        collapsable: {
          type: Boolean,
          value: true,
        },
        expandChildren: {
          type: Boolean,
          value: false,
        },
        url: {
          type: String,
        },
        __setLock: {
          type: Boolean,
          value: false,
        },
      },
      _openChanged: function (newValue, oldValue) {
        if (typeof newValue !== typeof undefined) {
          let target = this.$.container;
          if (newValue) {
            target.show();
          }
          else {
            target.hide();
          }
        }
      },
      _headerTapHandler: function (e) {
        var normalizedEvent = Polymer.dom(e);
        let roottarget = normalizedEvent.rootTarget;
        // trap multiple button hits / ensure that we can only expand if button clicked
        // vs the full item tapped which can then toggle open / closed state
        if (normalizedEvent.rootTarget.tagName === 'PAPER-BUTTON') {
          // only open for paper button if ENTER is hit and it's already open
          if (this.collapsable && !this.opened) {
            this.opened = !this.opened;
          }
          // set a lock to ensure this doesn't happen
          this.__setLock = true;
        }
        else if (normalizedEvent.rootTarget.tagName === 'LRNDESIGN-MAPMENU-HEADER') {
          // only allow if the lock isn't there; this way double events bubbling up
          // won't actually do anything
          if (this.collapsable && !this.__setLock) {
            this.opened = !this.opened;
          }
          this.__setLock = false;
        }
        else if (this.collapsable) {
          this.opened = !this.opened;
        }
      },
      ready: function () {
        this._observer =
        Polymer.dom(this.$.slot).observeNodes(info => {
          var submenus = info.addedNodes.filter(item => item.nodeName === 'LRNDESIGN-MAPMENU-SUBMENU');
          if (this.expandChildren) {
            for (let menu of submenus) {
              menu.setAttribute('opened', true);
            }
          }
        });
      }
    });
  </script>
</dom-module>
