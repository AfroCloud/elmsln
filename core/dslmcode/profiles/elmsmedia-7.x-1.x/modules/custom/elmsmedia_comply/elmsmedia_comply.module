<?php
/**
 * @file
 * Media integration improvements for ELMS Media distro.
 */

/**
 * Implements hook_node_insert().
 */
function elmsmedia_comply_node_insert($node) {
  _comply_update($node, 'create');
}

/**
 * Implements hook_node_update().
 */
function elmsmedia_comply_node_update($node) {
  _comply_update($node, 'create');
}

/**
 * Implements hook_node_delete().
 */
function elmsmedia_comply_node_delete($node) {
  _comply_update($node, 'delete');
}

/**
 * Push an update compliance
 * @param  object $node node being worked on
 * @param  string $op   operation to commit
 */
function _comply_update($node, $op) {
  // ensure this isn't a type we don't want to call comply about
  if (!in_array($node->type, array('section', 'cis_course'))) {
    // load associated course if there is one for this
    $course = '';
    if (isset($node->field_cis_course_ref[LANGUAGE_NONE][0]['target_id'])) {
      // load the course node
      $tmp = node_load($node->field_cis_course_ref[LANGUAGE_NONE][0]['target_id']);
      // convert to machine name
      $course = $tmp->field_course_machine_name[LANGUAGE_NONE][0]['value'];
    }
    // ship this data over to compliance
    $request = array(
      'method' => 'POST',
      'api' => '1',
      'bucket' => 'ecd',
      'path' => '/',
      'data' => array(
        'elmsln_module' => 'ecd_helper',
        'elmsln_callback' => 'asset',
        'title' => $node->title,
        'course' => $course,
        'url' => url('node/' . $node->nid, array('alias' => TRUE, 'absolute' => TRUE)),
        'uuid' => $node->uuid,
        'type' => 'media',
        'operation' => $op,
      ),
    );
    _elmsln_api_request($request);
  }
}
