<dom-module id="lrnapp-studio-kanban">
  <template>
    <style include="materializecss-styles"></style>
    <style>
      :host {
        display: block;
      }
      .projects-container {
        display: block;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        -webkit-box-pack: start;
        -ms-flex-pack: start;
        justify-content: flex-start;
        -webkit-box-align: start;
        -ms-flex-align: start;
        align-items: flex-start;
        overflow-x: scroll;
        height: 100vh;
        width: 100%;
      }
      .projects-container {
        scrollbar-face-color: #833900;
        scrollbar-shadow-color: #ffc107;
        scrollbar-highlight-color:#ffc107;
        scrollbar-3dlight-color: #ffc107;
        scrollbar-darkshadow-color: #ffc107;
        scrollbar-track-color: #ffc107;
        scrollbar-arrow-color: #ffc107;
      }
      .projects-container::-webkit-scrollbar-track {
        background-color: #833900;
      } /* the new scrollbar will have a flat appearance with the set background color */
      .projects-container::-webkit-scrollbar-thumb {
        background-color: #ffc107;
      } /* this will style the thumb, ignoring the track */
      .projects-container::-webkit-scrollbar-button {
        background-color: #833900;
      } /* optionally, you can style the top and the bottom buttons (left and right for horizontal bars) */
      .projects-container::-webkit-scrollbar-corner {
        background-color: #833900;
      } /* if both the vertical and the horizontal bars appear, then perhaps the right bottom corner*/
      .projects-container::-webkit-scrollbar {
        width: 1rem;
        height: 1rem;
      } /* this targets the default scrollbar (compulsory) */

      paper-button {
        padding: 0;
        margin: 0;
        min-width: 1rem;
      }
      .project-card {
        width: 100%;
        min-width: 25em;
        max-width: 30em;
      }
      .project-operations {
        position: absolute;
        top: 0;
        right: 0;
        padding: 1em;
      }
      .project-operations .operation {
        display: inline-flex;
        height: 2.5em;
        width: 2.5em;
      }
      .assignment-row {
        border: 1px solid #000000;
        background-color: #FFFFFF;
      }
      .assignment-row .assignment-row-button.active {
        background-color: var(--paper-amber-50);
        font-weight: bold;
      }
      .assignment-row:hover .assignment-operations {
        display: block;
        overflow: visible;
      }
      .assignment-row-button {
        width: 100%;
        justify-content: flex-start;
        height: 3em;
        text-transform: none;
      }
      .assignment-operations {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0;
        display: none;
      }
      .assignment-operations.show {
        display: block;
        overflow: visible;
      }
      .assignment-operations .operation {
        display: inline-flex;
        width: 2.5em;
        height: 2.5em;
      }

    </style>
    <iron-ajax auto
      url="[[projectData]]"
      last-response="{{projects}}"
      on-response="handleProjectResponse">
    </iron-ajax>
    <div id="loading">
      <p>Loading..</p>
      <elmsln-loading color="grey-text" size="epic"></elmsln-loading>
    </div>
    <iron-list items="[[_toArray(projects.data)]]" as="project" class="projects-container" grid>
      <template class="projects-container-items">
      <paper-card id$="project-[[project.id]]" class="project-card grey lighten-4" heading="{{project.title}}" elevation="2">
        <div class="project-operations">
          <lrnsys-dialog body-append id$="project-[[project.id]]-add" alt="Add assignment" class="circle operation" hover-class="amber lighten-2" header="Add assignment" hidden="[[!project.metadata.canUpdate]]">
            <iron-icon slot="button" icon="add"></iron-icon>
            <div slot="content">
              Add another assignment
            </div>
          </lrnsys-dialog>
          <lrnsys-button id$="project-[[project.id]]-delete" alt="Delete project!" class="circle operation" hover-class="red darken-2 white-text" header="Delete project!" hidden="[[!project.metadata.canDelete]]" icon="delete-forever" href$="[[project.metadata.deleteLink]]">
          </lrnsys-dialog>
        </div>
        <div class="card-content">
          <iron-list items="[[_toArray(project.assignments)]]" as="assignment">
            <template>
            <div class="assignment-row">
              <lrnsys-dialog body-append on-focusin="assignmentFocusIn" class="assignment-row-button" id$="assignment-[[project.id]]-[[assignment.id]]" header="[[assignment.title]]" hover-class="amber lighten-5">
                <span slot="button">
                  <iron-icon icon="[[assignment.icon]]"></iron-icon>
                  <span>[[assignment.title]]</span>
                </span>
                <div slot="content">
                  <h2>[[assignment.title]]</h2>
                  <lrnsys-render-html html="[[assignment.body]]"></lrnsys-render-html>
                 </div>
              </lrnsys-dialog>
              <span class="assignment-operations">
                <lrnsys-button id$="assignment-[[project.id]]-[[assignment.id]]-add-critique" icon="editor:insert-comment" alt="Add critique" class="circle operation" hover-class="green lighten-2" hidden="[[!assignment.metadata.canCritique]]" href$="[[assignment.metadata.critiqueLink]]"></lrnsys-button>
                <lrnsys-button id$="assignment-[[project.id]]-[[assignment.id]]-edit" icon="editor:mode-edit" alt="Edit" class="circle operation" hover-class="amber lighten-2" hidden="[[!assignment.metadata.canUpdate]]" href$="[[assignment.metadata.updateLink]]"></lrnsys-button>
                <lrnsys-button id$="assignment-[[project.id]]-[[assignment.id]]-delete" icon="delete" alt="Delete" class="circle operation" hover-class="red darken-2 white-text" hidden="[[!assignment.metadata.canDelete]]" href$="[[assignment.metadata.deleteLink]]"></lrnsys-button>
              </span>
            </div>
            </template>
          </iron-list>
        </div>
      </paper-card>
      </template>
    </iron-list>
  </template>

  <script>
    Polymer({
      is: 'lrnapp-studio-kanban',
      properties: {
        /**
         * Tracks the active assignment.
         */
        activeAssignment: {
          type: String,
          value: null,
        },
        projectData: {
          type: String
        },
      },
      handleProjectResponse: function(response) {
        let root = this;
        root.$.loading.hidden = true;
      },
      /*
       * Simple way to convert from object to array.
       */
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return obj[key];
        });
      },
      /**
       * Handle toggle for mouse class and manage classList array for paper-button.
       */
      assignmentFocusIn: function(e) {
        let root = this;
        var normalizedEvent = Polymer.dom(e);
        var local = normalizedEvent.localTarget;
        if (root.activeAssignment != null && root.activeAssignment != local.id) {
          root.$$('#' + root.activeAssignment).nextElementSibling.classList.remove('show');
          root.$$('#' + root.activeAssignment).classList.remove('active');
        }
        root.activeAssignment = local.id;
        local.nextElementSibling.classList.add('show');
        local.classList.add('active');
      },
    });
  </script>
</dom-module>
