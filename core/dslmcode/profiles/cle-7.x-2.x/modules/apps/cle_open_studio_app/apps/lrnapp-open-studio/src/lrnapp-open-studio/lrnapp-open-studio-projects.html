<link rel="import" href="../../../lrnapp-studio-submission/src/lrnapp-studio-submission/lrnapp-studio-submission-display.html">

<dom-module id="lrnapp-open-studio-projects">
  <template>
    <style include="materializecss-styles"></style>
    <style>
      :host {
        display: block;
        align-content: center;
      }
      #loading {
        width: 100%;
        z-index: 1000;
        opacity: .8;
        text-align: center;
        align-content: center;
        justify-content: center;
        height: 100vh;
        position: absolute;
        background-color: white;
      }
      h1.empty-title,
      h1.project-title {
        font-size: 2em;
      }
      h2.assignment-title {
        font-size: 1.5em;
        font-weight: bold;
        width: 100%;
        border-bottom: solid 1px grey;
      }
      .project-steps {
        display: flex;
        align-items: center;
      }
      .project-step {
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-all;
        word-wrap: break-word;
      }
    </style>
    <template is="dom-if" if="[[!_projectSelected(activeProjectId,activeAuthorId)]]">
      <h1 class="empty-title black-text">Please select an Author and Project in order to review their portfolio</h1>
    </template>
    <template is="dom-if" if="[[_projectSelected(activeProjectId,activeAuthorId)]]">
      <h1 class="project-title black-text">[[activeProject.attributes.title]]</h1>
      <div class="project-steps">
        <template is="dom-repeat" items="[[activeProject.attributes.steps]]" as="assignment">
          <lrnsys-button icon$="[[_getSubmissionIcon(assignment.id)]]" icon-class$="[[_getSubmissionClass(assignment.id)]]" on-tap="_scrollToTarget" label="[[assignment.title]]" data-assignment-id$="[[assignment.id]]" class="project-step" hover-class="blue white-text" raised hidden$="[[!assignment.title]]"></lrnsys-button>
        </template>
      </div>
      <template is="dom-repeat" items="[[renderSubmissions]]" as="submission">
        <a name="[[[submission.relationships.assignment.data.title]]" class$="assignment-[[submission.relationships.assignment.data.id]]"><h2 class="assignment-title">[[submission.relationships.assignment.data.title]]</h2></a>
        <lrnapp-studio-submission-display submission="[[submission]]" class="ferpa-protect"></lrnapp-studio-submission-display>
      </template>
    </template>
  </template>

  <script>
    Polymer({
      is: 'lrnapp-open-studio-projects',
      properties: {
        /**
         * The projects that exist so we can make other calls for data
         */
        projects: {
          type: Array,
          notify: true,
        },
        /**
         * The submissions that exist so we can make other calls for data
         */
        submissions: {
          type: Array,
          notify: true,
          observer: '_submissionsChanged',
        },
        /**
         * The renderSubmissions we kick to the screen
         */
        renderSubmissions: {
          type: Array,
          notify: true,
        },
        /**
         * The assignments that exist so we can make other calls for data
         */
        assignments: {
          type: Array,
          notify: true,
        },
        activeProjectId: {
          type: String,
          reflectToAttribute: true,
          value: null,
        },
        activeProject: {
          type: Object,
          value: null,
          notify: true,
        },
        activeAuthorId: {
          type: String,
          reflectToAttribute: true,
          value: null,
        },
        /**
         * Endpoint for submission data.
         */
        sourcePath: {
          type: String,
          notify: true,
        },
        /**
         * base path for the app
         */
        basePath: {
          type: String,
          notify: true,
        }
      },
      _getSubmissionIcon: function(id) {
        for (var index = 0; index < this.renderSubmissions.length; index++) {
          if (this.renderSubmissions[index].relationships.assignment.data.id == id) {
            return 'check';
          }
        }
        return 'assignment';
      },
      _getSubmissionClass: function(id) {
        for (var index = 0; index < this.renderSubmissions.length; index++) {
          if (this.renderSubmissions[index].relationships.assignment.data.id == id) {
            return 'green-text text-darken-2';
          }
        }
        return 'grey-text';
      },
      _scrollToTarget: function(e) {
        var normalizedEvent = Polymer.dom(e);
        var local = normalizedEvent.localTarget;
        // this will have the id of the current submission
        var active = local.getAttribute('data-assignment-id');
        console.log(local);
        console.log(active);
        this.$$('.assignment-' + active).scrollIntoView({block: "end", behavior: "smooth"});
      },
      _submissionsChanged: function(e) {
        if (this.activeProjectId) {
          // set this to window since it's a global of sorts
          window.projectSteps = this.activeProject.attributes.steps;
          // sort by the order the assignments are presented in for the project
          this.submissions.sort(
            function(a, b)
            {
              for (var index = 0; index < window.projectSteps.length; index++) {
                if (window.projectSteps[index].id == a.relationships.assignment.data.id) {
                  return -1;
                }
                if (window.projectSteps[index].id == b.relationships.assignment.data.id) {
                  return 1;
                }
              }
              return 0;
            }
          );
          this.set('renderSubmissions', this.submissions);
        }
      },
      /**
       * Make sure we have a project / author before we render or else it'll blow up
       */
      _projectSelected: function(project, author) {
        if (project != null && author != null) {
          for (var index = 0; index < this.projects.length; index++) {
            if (this.projects[index].id == this.activeProjectId) {
              this.set('activeProject', [null]);
              this.set('activeProject', this.projects[index]);
            }
          }
          this.set('renderSubmissions', this.submissions);
          return true;
        }
        else {
          this.set('renderSubmissions', []);
          return false;
        }
      },
      /**
       * Handle response for the whole projects object.
       */
      _handleResponse: function(event) {
        this.$.loading.hidden = true;
      },
      /**
       * Simple way to convert from object to array.
       */
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return obj[key];
        });
      },
    });
  </script>
</dom-module>