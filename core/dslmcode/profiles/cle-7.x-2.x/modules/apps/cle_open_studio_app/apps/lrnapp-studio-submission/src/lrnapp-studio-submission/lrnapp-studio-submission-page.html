<link rel="import" href="lrnapp-studio-submission-display.html">
<link rel="import" href="lrnapp-studio-submission-edit.html">
<link rel="import" href="lrnapp-studio-submission-critique.html">
<link rel="import" href="lrnapp-studio-submission-comments.html">
<link rel="import" href="lrnapp-studio-submission-comment.html">
<link rel="import" href="../../bower_components/lrnsys-comment/lrnsys-comment-list.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<dom-module id="lrnapp-studio-submission-page">
  <template>
    <style>
       :host {
        display: block;
        position: relative;
      }

      p {
        font-size: 14px;
        line-height: 18px;
      }

      h1 {
        margin: 0;
        text-align: left;
      }

      iron-selector {
        line-height: 1em;
      }

      iron-selector lrnsys-button {
        display: inline-flex;
      }

      lrndesign-contentblock {
        margin: .5em;
      }

      iron-image {
        margin: 0 .5em;
      }

      lrnsys-dialog {
        display: inline;
      }

      .contain {
        width: 10em;
        height: 10em;
        background: #ddd;
      }

      .center {
        margin: auto;
        width: 100%;
      }

      .title {
        color: #222;
        font-size: 2rem;
        font-weight: 600;
        line-height: 2.5rem;
        padding: 0.25rem 0;
        white-space: nowrap;
        overflow-x: hidden;
        text-overflow: ellipsis;
        margin-top: 1rem;
        text-transform: uppercase;
        text-align: left;
      }

      .author {
        color: #555;
        font-size: 1rem;
        font-weight: 500;
        font-style: normal;
        line-height: 1rem;
        padding: 0.25rem 0 0.5rem 0;
        margin: 0;
        text-transform: capitalize;
      }

      .comments {
        text-align: right;
        margin: 0;
        font-size: 1.5em;
      }

      .flex-wrap {
        display: flex;
      }

      .submission-page-wrapper {
        padding: 0 1em;
      }

      .submission-page {
        width: 70vw;
      }

      .submission-page-card {
        width: 100%;
        margin: 0;
        padding: 0 0 2em 1em;
      }

       :host[edit-page] .submission-page {
        width: 100%;
      }

      .submission-comments {
        width: 40vw;
        overflow-y: visible;
        padding: 0;
        margin: 0;
      }

      lrnapp-studio-submission-edit {
        width: 100%;
      }

      elmsln-loading {
        position: absolute;
        display: none;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 10;
        align-items: flex-end;
        justify-content: center;
      }

       :host[saving] elmsln-loading {
        display: block;
      }

      elmsln-loading ::shadow>lrn-icon {
        top: calc(50% - 5vmax);
        left: calc(50% - 5vmax);
        position: fixed;
        transform-origin: center center;
        width: 10vmax !important;
        height: 10vmax !important;
      }

      iron-pages {
        width: 100%;
      }

      lrnapp-studio-submission-edit {
        max-width: 70em;
        margin: auto;
      }
    </style>

    <app-route route="{{route}}" pattern="/edit" tail="{{tail}}" active="{{editPage}}">
    </app-route>

    <iron-ajax id="ajaxRequest" auto url="[[reqUrl]]" method="GET" params="[[reqParams]]" content-type="application/json" handle-as="json"
      on-response="_handleResponse"></iron-ajax>
    <!-- Update Submission Node -->
    <iron-ajax id="ajaxUpdateRequest" url="[[reqUrl]]" method="PUT" body="[[submission]]" params="[[reqParams]]" content-type="application/json"
      handle-as="json" on-response="_handleUpdateResponse"></iron-ajax>    <!-- Delete Submission Node -->
    <iron-ajax id="ajaxDeleteRequest" url="[[reqUrl]]" method="DELETE" params="[[reqParams]]" content-type="application/json"
      handle-as="json" on-response="_handleDeleteResponse"></iron-ajax>

    <app-toolbar class="amber lighten-3">
      <lrnsys-button on-tap="_backToStudio" icon="arrow-back" label="Back to studio" hover-class="amber darken-4 white-text"></lrnsys-button>
      <div spacer main-title>[[submission.attributes.title]]</div>
      <div spacer class="comment-box">
        <paper-button id="comment-count" style="margin:0;padding:.25em;text-transform:none;">
          <iron-icon icon="communication:forum"></iron-icon>
          [[submission.meta.comment_count]] Comments
        </paper-button>
        <paper-badge hidden$="[[displayNewBadge(submission.meta.comment_new)]]" for="comment-count" label$="[[submission.meta.comment_new]]"></paper-badge>
      </div>
      <div hidden$="[[editPage]]">
        <lrnsys-button on-tap="_setEditRoute" icon="create" label="Edit" hover-class="amber darken-4 white-text" hidden$="[[!submission.meta.canUpdate]]"></lrnsys-button>
      </div>
      <div hidden$="[[!editPage]]">
        <lrnsys-button on-tap="_resetRoute" icon="cancel" label="Cancel" hover-class="amber darken-4 white-text" hidden$="[[!submission.meta.canUpdate]]"></lrnsys-button>
      </div>
    </app-toolbar>

    <template is="dom-if" if="[[submission]]">
      <div class="flex-wrap submission-page-wrapper">
        <template is="dom-if" if="[[showComments]]">
          <div class="submission-comments">
            <lrnsys-comment-list comment-ops-base="{{commentOpsBase}}" csrf-token="[[csrfToken]]" source-path="{{commentsUrl}}" create-stub-url="{{createStubUrl}}"></lrnsys-comment-list>
          </div>
        </template>

        <iron-pages selected="[[selectedPage]]">
          <lrnapp-studio-submission-display submission="{{submission}}"></lrnapp-studio-submission-display>
          <lrnapp-studio-submission-edit submission="{{submission}}"></lrnapp-studio-submission-edit>
          <lrnapp-studio-submission-critique submission="{{submission}}"></lrnapp-studio-submission-critique>
        </iron-pages>
      </div>
    </template>

    <elmsln-loading></elmsln-loading>
  </template>
  <script>
    Polymer({
      is: 'lrnapp-studio-submission-page',
      properties: {
        id: {
          type: String
        },
        endPoint: {
          type: String
        },
        basePath: {
          type: String,
        },
        csrfToken: {
          type: String
        },
        reqUrl: {
          type: String
        },
        reqParams: {
          type: Object
        },
        submission: {
          type: Object
        },
        commentsUrl: {
          type: String,
          computed: '_computeCommentsUrl(id, endPoint, csrfToken)'
        },
        createStubUrl: {
          type: String,
          computed: '_computeCommentsStubUrl(id, endPoint, csrfToken)'
        },
        commentOpsBase: {
          type: String,
          computed: '_computeCommentsOpsUrl(id, endPoint, csrfToken)'
        },
        editPage: {
          type: Boolean,
          reflectToAttribute: true
        },
        saving: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },
        selectedPage: {
          type: Number,
          value: 0
        },
        showComments: {
          type: Boolean,
          computed: '_computeShowComments(submission, editPage)'
        }
      },
      observers: [
        '_urlVarsChanged(id, endPoint)',
        '_paramsChanged(csrfToken)',
        '_bodyChanged(title)',
        '_selectedPageChanged(editPage, submission.meta.submissionType)'
      ],
      listeners: {
        'submissionDeleteClicked': '_submissionDeleteClicked',
        'submissionPublishClicked': '_submissionPublishClicked',
        'submissionSaveDraftClicked': '_submissionSaveDraftClicked'
      },
      /**
       * Go back to the studio relative to the app's path.
       */
      _backToStudio: function (e) {
        window.location.href = this.basePath + 'lrnapp-open-studio';
      },
      /**
       * Trigger the page router to invoke edit state.
       */
      _setEditRoute: function (e) {
        this.set('route.path', 'edit');
      },
      /**
       * Trigger the page router to invoke edit state.
       */
      _resetRoute: function (e) {
        this.set('route.path', '');
      },
      /**
       * if we should show new badge based on new comment count.
       */
      displayNewBadge: function (count) {
        if (count == 0) {
          return true;
        }
        return false;
      },
      _computeCommentsUrl: function (id, endPoint, csrfToken) {
        return endPoint + '/api/submissions/' + id + '/comments?token=' + csrfToken;
      },
      _computeCommentsOpsUrl: function (id, endPoint, csrfToken) {
        return endPoint + '/api/submissions/' + id + '/comments';
      },
      _computeCommentsStubUrl: function (id, endPoint, csrfToken) {
        return endPoint + '/api/submissions/' + id + '/comments/create-stub?token=' + csrfToken;
      },
      _urlVarsChanged: function (id, endPoint) {
        this.reqUrl = endPoint + '/api/submissions/' + id;
      },
      _paramsChanged: function (csrfToken) {
        var params = this.reqParams || {};
        params.token = csrfToken;
        this.reqParams = params;
      },
      _handleResponse: function (data) {
        this.set('submission', data.detail.response.data);
      },
      _isReply: function (data) {
        this.thread = submission.relationships.comments.data.attributes.thread;
      },
      _submissionSaveDraftClicked: function (e) {
        this.saving = true;
        this.$$('#ajaxUpdateRequest').generateRequest();
      },
      _submissionPublishClicked: function (e) {
        this.saving = true;
        this.$$('#ajaxUpdateRequest').generateRequest();
      },
      _submissionDeleteClicked: function (e) {
        this.saving = true;
        this.$.ajaxDeleteRequest.generateRequest();
      },
      _handleUpdateResponse: function (res) {
        var root = this;
        var status = res.detail.response.status;
        var submission = res.detail.response.data;
        root.saving = false;
        if (status === 200) {
          root.set('submission', {});
          root.set('submission', submission);
          root.set('route.path', '');
        }
      },
      _handleDeleteResponse: function (res) {
        var root = this;
        var status = res.detail.response.status;
        root.saving = false;
        if (status === 200) {
          this.set('route.path', '');
        }
      },
      _selectedPageChanged: function (editPage, type) {
        var selected = 0;
        if (editPage) {
          switch (type) {
            case 'default':
              selected = 1;
              break;
            case 'critique':
              selected = 2;
              break;
          }
        }
        else {
          switch (type) {
            case 'default':
              selected = 0;
              break;
            case 'critique':
              selected = 2;
              break;
          }
        }
        this.set('selectedPage', selected);
      },
      _computeShowComments: function (submission, editPage) {
        try {
          var type = submission.meta.submissionType;
          if (type !== 'critique' && !editPage && submission.attributes.state == 'submission_ready') {
            return true;
          }
        } catch (error) {
        }
        return false;
      },
      /**
      * Simple way to convert from object to array.
      */
      _toArray: function (obj) {
        if (typeof obj === 'object' && obj !== null) {
          return Object.keys(obj).map(function (key) {
            return obj[key];
          });
        }
        return [];
      }
    });
  </script>
</dom-module>