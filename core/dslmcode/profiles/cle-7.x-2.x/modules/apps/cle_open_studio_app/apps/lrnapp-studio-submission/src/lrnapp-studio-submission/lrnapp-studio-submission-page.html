<link rel="import" href="lrnapp-studio-submission-edit.html">
<link rel="import" href="lrnapp-studio-submission-comments.html">
<link rel="import" href="lrnapp-studio-submission-comment.html">
<link rel="import" href="../../bower_components/lrnsys-comment/lrnsys-comment-list.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<dom-module id="lrnapp-studio-submission-page">
  <template>
    <style>
       :host {
        display: block;
      }

      p {
        font-size: 14px;
        line-height: 18px;
      }

      iron-selector {
        line-height: 1em;
      }
      iron-selector lrnsys-button {
        display: inline-flex;
      }

      lrndesign-contentblock {
        margin: .5em;
      }

      iron-image {
        margin: 0 .5em;
      }

      lrnsys-dialog {
        display: inline;
      }

      paper-card {
        padding: 2em;
      }

      .contain {
        width: 10em;
        height: 10em;
        background: #ddd;
      }

      .center {
        margin: auto;
        width: 100%;
      }

      h1,
      h2,
      h3,
      h4 {
        margin: 0;
        text-align: left;
      }

      .title {
        color: #222;
        font-size: 2rem;
        font-weight: 600;
        line-height: 2.5rem;
        padding: 0.25rem 0;
        white-space: nowrap;
        overflow-x: hidden;
        text-overflow: ellipsis;
        margin-top: 1rem;
        text-transform: uppercase;
        text-align: left;
      }

      .author {
        color: #555;
        font-size: 1rem;
        font-weight: 500;
        font-style: normal;
        line-height: 1rem;
        padding: 0.25rem 0 0.5rem 0;
        margin: 0;
        text-transform: capitalize;
      }

      .comments {
        text-align: right;
        margin: 0;
        font-size: 1.5em;
      }

      .flex-wrap {
        display: flex;
      }
      .submission-page-wrapper {
        padding: 0 1em;
      }

      .submission-page {
        width: 70vw;
      }
      .submission-page paper-card {
        width: 100%;
        margin: 0;
        padding-top: 0;
      }

      :host[edit-page] .submission-page {
        width: 100%;
      }

      .submission-comments {
        width: 30vw;
        overflow-y: visible;
        padding: 0;
        margin: 0;
      }
    </style>

    <app-route route="{{route}}" pattern="/edit" tail="{{tail}}" active="{{editPage}}">
    </app-route>


    <iron-ajax id="ajaxRequest" auto url="[[reqUrl]]" method="GET" body="[[reqBody]]" params="[[reqParams]]" content-type="application/json"
      handle-as="json" on-response="_handleResponse"></iron-ajax>
    <div class="flex-wrap submission-page-wrapper">
      <template is="dom-if" if="[[!editPage]]">
        <div class="submission-comments">
          <lrnsys-comment-list comment-ops-base="{{commentOpsBase}}" csrf-token="[[csrfToken]]" source-path="{{commentsUrl}}" create-stub-url="{{createStubUrl}}"></lrnsys-comment-list>
        </div>
      </template>
      <div class="submission-page">
        <paper-card>
        <div class="card-content">
          <template is="dom-if" if="[[editPage]]">
            <app-toolbar class$="[[submission.meta.color]]">
              <div>
                <iron-icon icon="[[submission.meta.icon]]"></iron-icon>
                {{submission.attributes.title}}
              </div>
              <div spacer class="comment-box" hidden$="[[!submission.id]]">
                <paper-button id="submission-comments-overview" style="margin:0;padding:.25em;text-transform:none;">
                  <iron-icon icon="communication:forum"></iron-icon>
                  [[submission.meta.comment_count]] Comments
                </paper-button>
                <paper-badge hidden$="[[displayNewBadge(submission.meta.comment_new)]]" for="submission-comments-overview" label$="[[submission.meta.comment_new]]"></paper-badge>
              </div>
              <div main-title></div>
              <span></span>
              <div bottom-item class="status-rationale">
                [[assignment.metadata.relatedSubmissions.complete.rationale.text]]
              </div>
            </app-toolbar>
            <lrnapp-studio-submission-edit submission="{{submission}}" id="[[id]]" end-point="[[endPoint]]" csrf-token="[[csrfToken]]" on-updated="_submissionUpdated"></lrnapp-studio-submission-edit>
          </template>
          <template is="dom-if" if="[[!editPage]]">
            <h1 class="title">{{submission.attributes.title}}</h1>
            <div class="author">By: {{submission.relationships.author.data.name}}</div>
            <div class="status">Status: {{submission.attributes.state}}</div> 
            <lrnsys-button name="edit" on-tap="_setEditRoute" icon="create" label="Edit submission" hover-class="amber darken-4 white-text"></lrnsys-button>
            <!-- ----- Text Submission -----  -->
            <template is="dom-if" if="[[submission.attributes.body]]">
              <lrndesign-contentblock title="Text Submitted">
                <marked-element markdown="[[submission.attributes.body]]"></marked-element>
              </lrndesign-contentblock>
            </template>
            <!-- ----- Images Submission -----  -->
            <template is="dom-if" if="[[submission.attributes.images]]">
              <lrndesign-contentblock class="center" title="Images Submitted">
                <template is="dom-repeat" items="[[_toArray(submission.attributes.images)]]" as="image">
                  <lrnsys-dialog alt="View Image">
                    <span slot="button">
                      <iron-image sizing="contain" class="contain" src="[[image.url]]"></iron-image>
                    </span>
                    <iron-image src="[[image.url]]"></iron-image>
                  </lrnsys-dialog>
                </template>
              </lrndesign-contentblock>
            </template>
            <!-- ----- Video Submission -----  -->
            <template is="dom-if" if="[[submission.attributes.video]]">
              <lrndesign-contentblock class="center" title="Videos Submitted">
                <template is="dom-repeat" items="[[_toArray(submission.attributes.video)]]" as="video">
                  <iframe width="460" height="249" src="[[video.video_src]]"></iframe>
                </template>
              </lrndesign-contentblock>
            </template>
            <!-- ----- Links Submission -----  -->
            <template is="dom-if" if="[[submission.attributes.links]]">
              <lrndesign-contentblock title="Links Submitted">
                <template is="dom-repeat" items="[[_toArray(submission.attributes.links)]]" as="link">
                  <p><strong>[[link.title]]:</strong>
                    <a class="link" href="[[link.url]]" target="_blank">[[link.url]]</a></p>
                </template>
              </lrndesign-contentblock>
            </template>
            <!-- ----- Files Submission -----  -->
            <template is="dom-if" if="[[submission.attributes.files]]">
              <lrndesign-contentblock title="Files Submitted">
                <template is="dom-repeat" items="[[_toArray(submission.attributes.files)]]" as="file">
                  <p><strong>[[file.filename]]:</strong>
                    <a class="link" href="[[file.url]]" target="_blank">[[file.url]]</a></p>
                </template>
              </lrndesign-contentblock>
            </template>
          </template>
          </div>
        </paper-card>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'lrnapp-studio-submission-page',
      properties: {
        id: {
          type: String
        },
        endPoint: {
          type: String
        },
        csrfToken: {
          type: String
        },
        reqUrl: {
          type: String
        },
        reqParams: {
          type: Object
        },
        reqBody: {
          type: Object
        },
        submission: {
          type: Object
        },
        commentsUrl: {
          type: String,
          computed: '_computeCommentsUrl(id, endPoint, csrfToken)'
        },
        createStubUrl: {
          type: String,
          computed: '_computeCommentsStubUrl(id, endPoint, csrfToken)'
        },
        commentOpsBase: {
          type: String,
          computed: '_computeCommentsOpsUrl(id, endPoint, csrfToken)'
        },
        editPage: {
          type: Boolean,
          reflectToAttribute: true
        }
      },
      observers: [
        '_urlVarsChanged(id, endPoint)',
        '_paramsChanged(csrfToken)',
        '_bodyChanged(title)'
      ],
      _setEditRoute: function(e) {
        this.set('route.path', 'edit');
      },
      /**
       * if we should show new badge based on new comment count.
       */
      displayNewBadge: function(count) {
        if (count == 0) {
          return true;
        }
        return false;
      },
      _computeCommentsUrl: function (id, endPoint, csrfToken) {
        return endPoint + '/api/submissions/' + id + '/comments?token=' + csrfToken;
      },
      _computeCommentsOpsUrl: function (id, endPoint, csrfToken) {
        return endPoint + '/api/submissions/' + id + '/comments';
      },
      _computeCommentsStubUrl: function (id, endPoint, csrfToken) {
        return endPoint + '/api/submissions/' + id + '/comments/create-stub?token=' + csrfToken;
      },
      _urlVarsChanged: function (id, endPoint) {
        this.reqUrl = endPoint + '/api/submissions/' + id;
      },
      _paramsChanged: function (csrfToken) {
        var params = this.reqParams || {};
        params.token = csrfToken;
        this.reqParams = params;
      },
      _handleResponse: function (data) {
        this.submission = data.detail.response.data;
      },
      _isReply: function (data) {
        this.thread = submission.relationships.comments.data.attributes.thread;
      },
      _submissionUpdated: function (e) {
        var type = e.detail.type;
        console.log(type);
        if (type === 'update') {
          // navigate to the main page
          this.set('route.path', '');
          console.log('set');
          // refresh the data
          this.$$('#ajaxRequest').generateRequest();
        }
        else if (type === 'delete') {
          this.set('route.path', '');
          this.fire('submissionDeleted', { submission: this.submission });
          this.submission = {};
        }
     },
      /**
       * Simple way to convert from object to array.
       */
      _toArray: function (obj) {
        return Object.keys(obj).map(function (key) {
          return obj[key];
        });
      },
    });
  </script>
</dom-module>